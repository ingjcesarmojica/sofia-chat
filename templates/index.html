<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sofia - Asistente Virtual</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }
        
        .container { 
            background: white; 
            border-radius: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            width: 100%;
            height: 100vh;
            max-width: 100%;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .header { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white;
            padding: 20px 15px 15px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .logo-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .logo {
            height: 35px;
            width: auto;
            max-width: 85%;
        }
        
        .header-content {
            margin-top: 55px;
        }
        
        .avatar-container {
            position: relative; 
            margin: 0 auto 10px; 
            width: 90px; 
            height: 90px;
        }
        
        .avatar { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.5);
            background: #e0e0e0 url('https://bidamericas.com/tusabogados/foto.png') center/cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        h1 { 
            font-size: 22px; 
            margin-bottom: 5px; 
            font-weight: 600;
        }
        
        .subtitle { 
            font-size: 14px; 
            opacity: 0.9; 
            margin-bottom: 10px; 
        }
        
        /* Tabs Navigation */
        .tabs { 
            display: flex; 
            background: rgba(255,255,255,0.15); 
            border-radius: 20px; 
            padding: 3px; 
            margin: 12px auto 0; 
            width: 90%;
        }
        
        .tab { 
            flex: 1; 
            text-align: center; 
            padding: 8px 5px; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-size: 13px; 
            font-weight: bold;
        }
        
        .tab.active { 
            background: white; 
            color: #3498db; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Tab Content */
        .tab-content { 
            display: none; 
            flex-grow: 1;
            overflow: hidden;
            height: 100%;
            flex-direction: column;
        }
        
        .tab-content.active { 
            display: flex; 
        }
        
        /* Voice Tab */
        .voice-tab-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            height: 100%;
        }
        
        .talk-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 16px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 25px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .talk-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        
        .talk-button:active {
            transform: translateY(1px);
        }
        
        .talk-button.listening {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .voice-instructions {
            margin-top: 20px; 
            color: #777; 
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
        }
        
        /* Chat Tab */
        .chat-tab-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
            position: relative;
        }
        
        .chat-container { 
            flex: 1;
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 15px;
            padding-bottom: 70px;
        }
        
        .message { 
            margin-bottom: 12px; 
            padding: 10px 14px; 
            border-radius: 18px; 
            max-width: 85%; 
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .user-message { 
            background: #3498db; 
            color: white; 
            margin-left: auto; 
            border-bottom-right-radius: 5px;
        }
        
        .sofia-message { 
            background: white; 
            color: #2c3e50; 
            border: 1px solid #e0e0e0; 
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Input Container */
        .input-container { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px; 
            background: white; 
            border-top: 1px solid #e0e0e0; 
            display: flex; 
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        input { 
            flex: 1; 
            padding: 12px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 25px; 
            outline: none;
            font-size: 15px; 
            transition: border-color 0.3s;
            height: 45px;
        }
        
        input:focus { 
            border-color: #3498db; 
        }
        
        .send-btn { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer; 
            font-weight: bold; 
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .send-btn:hover { 
            transform: scale(1.05); 
        }
        
        /* Indicators */
        .typing-indicator { 
            display: none; 
            padding: 10px 14px; 
            background: white; 
            border-radius: 18px; 
            border: 1px solid #e0e0e0;
            width: fit-content; 
            margin-bottom: 12px; 
            font-style: italic; 
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .status-indicator {
            position: absolute;
            top: 60px;
            right: 10px;
            font-size: 10px;
            background: rgba(255,255,255,0.3);
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        /* Media Queries responsive */
        @media (max-height: 700px) {
            .header { padding: 15px 15px 10px; }
            .logo { height: 30px; }
            .logo-container { padding: 10px 0; }
            .header-content { margin-top: 45px; }
            .avatar-container { width: 75px; height: 75px; margin-bottom: 8px; }
            h1 { font-size: 20px; }
            .subtitle { font-size: 13px; }
            .tab { padding: 6px 4px; font-size: 12px; }
            .chat-container { padding: 12px; padding-bottom: 65px; }
            .message { padding: 8px 12px; font-size: 13px; }
            .talk-button { padding: 14px 25px; font-size: 15px; margin: 20px 0; }
            .status-indicator { top: 50px; }
            .input-container { padding: 12px; }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .container { height: 100vh; border-radius: 0; }
            .header { padding: 10px 15px 8px; }
            .logo-container { padding: 8px 0; }
            .logo { height: 28px; }
            .header-content { margin-top: 40px; }
            .avatar-container { width: 60px; height: 60px; margin-bottom: 5px; display: inline-block; vertical-align: middle; margin-right: 10px; }
            .header-text { display: inline-block; vertical-align: middle; text-align: left; }
            h1 { font-size: 18px; margin-bottom: 0; }
            .subtitle { font-size: 11px; margin-bottom: 0; }
            .tabs { width: auto; display: inline-block; margin-left: 10px; }
            .voice-tab-content { padding: 10px; }
            .talk-button { padding: 10px 20px; font-size: 14px; margin: 15px 0; }
            .status-indicator { top: 40px; }
            .chat-container { padding-bottom: 60px; }
        }
        
        @media (max-width: 350px) {
            .logo { height: 30px; }
            .logo-container { padding: 10px 0; }
            .header-content { margin-top: 45px; }
            .avatar-container { width: 70px; height: 70px; }
            h1 { font-size: 20px; }
            .talk-button { padding: 12px 20px; font-size: 15px; }
            .status-indicator { top: 50px; }
            .input-container { padding: 10px; }
            input { padding: 10px 12px; font-size: 14px; }
            .chat-container { padding-bottom: 60px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://bidamericas.com/tusabogados/logo.png" alt="Fusa Abogados" class="logo">
            </div>
            <div class="status-indicator" id="statusIndicator">🔴 Cargando voz...</div>
            
            <div class="header-content">
                <div class="avatar-container">
                    <div class="avatar"></div>
                </div>
                <div class="header-text">
                    <h1>Sofia 💡</h1>
                    <p class="subtitle">Representante de atención al cliente</p>
                </div>
                
                <!-- Tabs Navigation -->
                <div class="tabs">
                    <div class="tab" data-tab="chat">Chat</div>
                    <div class="tab active" data-tab="voice">Voz</div>
                </div>
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div class="tab-content" id="chatTab">
            <div class="chat-tab-content">
                <div class="chat-container" id="chatBox">
                    <div class="message sofia-message">
                        ¡Hola! Soy Sofia, tu representante de atención al cliente. ¿En qué puedo ayudarte hoy?
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        Sofia está escribiendo...
                    </div>
                </div>

                <div class="input-container">
                    <input type="text" id="userInput" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">→</button>
                </div>
            </div>
        </div>

        <!-- Voice Tab Content -->
        <div class="tab-content active" id="voiceTab">
            <div class="voice-tab-content">
                <button class="talk-button" id="talkButton" onclick="startVoiceRecognition()">
                    🎤 Hablar con Sofia
                </button>
                
                <div class="voice-instructions">
                    <p>Haz clic en el botón y permite el acceso al micrófono cuando te lo solicite el navegador. Sofia responderá con una voz latina cálida y profesional.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let voiceSupported = false;
        let recognition = null;
        let selectedVoice = null;
        let isVoicesLoaded = false;
        
        // Configuración específica de voz según la imagen
        const VOICE_SETTINGS = {
            pitch: 1.1,        // Tono de voz: 1.1
            rate: 1.1,         // Velocidad: 1.1
            volume: 1.0,
            preferredLang: 'es-US'  // Idioma: es-US (Español Estados Unidos)
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkVoiceSupport();
            setupTabs();
            loadOptimalVoice();
            adjustChatHeight();
            
            window.addEventListener('resize', adjustChatHeight);
            window.addEventListener('orientationchange', adjustChatHeight);
        }

        function checkVoiceSupport() {
            voiceSupported = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            const speechSupported = 'speechSynthesis' in window;
            
            if (voiceSupported && speechSupported) {
                updateStatus('🟢 Sistema de voz activo');
            } else {
                updateStatus('🔴 Voz no compatible');
            }
        }
        
        function updateStatus(message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            
            if (message.includes('🟢')) {
                indicator.style.background = 'rgba(46, 204, 113, 0.3)';
            } else if (message.includes('🔴')) {
                indicator.style.background = 'rgba(231, 76, 60, 0.3)';
            } else {
                indicator.style.background = 'rgba(255, 193, 7, 0.3)';
            }
        }

        function loadOptimalVoice() {
            let attempts = 0;
            const maxAttempts = 3;
            
            function tryLoadVoices() {
                attempts++;
                const voices = speechSynthesis.getVoices();
                
                if (voices.length > 0) {
                    selectBestVoice(voices);
                    isVoicesLoaded = true;
                } else if (attempts < maxAttempts) {
                    setTimeout(tryLoadVoices, 500);
                } else {
                    updateStatus('⚠️ Usando voz por defecto');
                }
            }
            
            tryLoadVoices();
            
            speechSynthesis.addEventListener('voiceschanged', () => {
                if (!isVoicesLoaded) {
                    tryLoadVoices();
                }
            });
        }

        function selectBestVoice(voices) {
            // Priorizar voces en español de Estados Unidos (es-US)
            let bestVoice = null;
            let bestScore = 0;
            
            voices.forEach(voice => {
                let score = 0;
                const name = voice.name.toLowerCase();
                const lang = voice.lang.toLowerCase();
                
                // Priorizar es-US (Español Estados Unidos)
                if (lang === 'es-us') score += 100;
                else if (lang.startsWith('es-')) score += 50;
                else if (lang.includes('spanish') || lang.includes('español')) score += 30;
                
                // Puntuar por características femeninas
                if (name.includes('female') || name.includes('mujer')) score += 15;
                if (name.includes('sabina') || name.includes('helena')) score += 20;
                if (name.includes('mónica') || name.includes('lucía')) score += 18;
                if (name.includes('paloma') || name.includes('sofia')) score += 16;
                if (name.includes('dalia') || name.includes('elena')) score += 14;
                
                // Puntuar por calidad
                if (name.includes('neural') || name.includes('premium')) score += 10;
                if (voice.localService) score += 5;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestVoice = voice;
                }
            });
            
            if (bestVoice) {
                selectedVoice = bestVoice;
                updateStatus(`🎤 Voz: ${bestVoice.name.split(' ')[0]} (${bestVoice.lang})`);
                console.log('Voz seleccionada:', bestVoice.name, bestVoice.lang);
                
                // Probar la voz con el mensaje específico
                setTimeout(() => {
                    speakText("Hola, mi nombre es Sofia. Soy tu asistente virtual con una voz latina cálida y profesional. ¿En qué puedo ayudarte hoy?");
                }, 500);
            } else {
                // Fallback a la primera voz disponible
                selectedVoice = voices[0];
                updateStatus('⚠️ Usando voz disponible');
            }
        }

        function speakText(text) {
            if (!selectedVoice) {
                console.log('Voz no disponible, intentando cargar...');
                loadOptimalVoice();
                setTimeout(() => speakText(text), 1000);
                return;
            }
            
            // Cancelar cualquier síntesis previa
            speechSynthesis.cancel();
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Aplicar la configuración específica de la imagen
                utterance.voice = selectedVoice;
                utterance.pitch = VOICE_SETTINGS.pitch;  // Tono: 1.1
                utterance.rate = VOICE_SETTINGS.rate;    // Velocidad: 1.1
                utterance.volume = VOICE_SETTINGS.volume;
                utterance.lang = selectedVoice.lang;
                
                // Eventos de control
                utterance.onstart = () => {
                    console.log(`🎤 Hablando con ${selectedVoice.name}`);
                };
                
                utterance.onend = () => {
                    console.log('✅ Reproducción completada');
                };
                
                utterance.onerror = (event) => {
                    console.error('Error en síntesis:', event.error);
                    if (event.error === 'invalid-argument' || event.error === 'voice-unavailable') {
                        // Recargar voces si hay problema
                        loadOptimalVoice();
                    }
                };
                
                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Error crítico:', error);
                }
            }, 100);
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                    
                    setTimeout(adjustChatHeight, 50);
                });
            });
        }

        function adjustChatHeight() {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                const headerHeight = document.querySelector('.header').offsetHeight;
                const inputHeight = document.querySelector('.input-container').offsetHeight;
                const windowHeight = window.innerHeight;
                
                chatContainer.style.height = (windowHeight - headerHeight - inputHeight) + 'px';
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function startVoiceRecognition() {
            if (!voiceSupported) {
                alert('El reconocimiento de voz no es compatible con tu navegador. Usa Chrome o Edge.');
                return;
            }

            const talkButton = document.getElementById('talkButton');
            
            if (recognition && recognition.isListening) {
                recognition.stop();
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                talkButton.textContent = '🔴 Escuchando...';
                talkButton.classList.add('listening');
                recognition.isListening = true;
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                sendMessage();
                
                talkButton.textContent = '🎤 Hablar con Sofia';
                talkButton.classList.remove('listening');
                recognition.isListening = false;
            };
            
            recognition.onerror = function(event) {
                talkButton.textContent = '🎤 Hablar con Sofia';
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    alert('Error en reconocimiento: ' + event.error);
                }
            };
            
            recognition.onend = function() {
                talkButton.textContent = '🎤 Hablar con Sofia';
                talkButton.classList.remove('listening');
                recognition.isListening = false;
            };
            
            try {
                recognition.start();
            } catch (error) {
                alert('Error al activar el micrófono.');
            }
        }

        function addMessage(message, isUser = false) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message sofia-message';
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                showTypingIndicator();
                
                // Cambiar a la pestaña de chat
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="chat"]').classList.add('active');
                document.getElementById('chatTab').classList.add('active');
                
                // Simular respuesta inteligente
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateResponse(message);
                    addMessage(response, false);
                    
                    // Hablar con la voz configurada
                    speakText(response);
                    
                    adjustChatHeight();
                }, Math.random() * 1000 + 1500);
            }
        }
        
        function generateResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('hola') || message.includes('buenos') || message.includes('saludos')) {
                const greetings = [
                    "¡Hola! Es un placer saludarte. Soy Sofia y estoy aquí para ayudarte en lo que necesites.",
                    "¡Buenos días! Soy Sofia, tu asistente virtual. ¿Cómo puedo hacer que tu día sea mejor?",
                    "¡Hola! Me alegra mucho que te pongas en contacto conmigo. ¿En qué puedo asistirte hoy?"
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            if (message.includes('gracias') || message.includes('te agradezco')) {
                const thanks = [
                    "¡De nada! Es un placer poder ayudarte. Estoy aquí cuando me necesites.",
                    "No hay de qué agradecer. Me encanta poder asistirte en lo que requieras.",
                    "¡Con mucho gusto! Siempre es un placer ayudar a nuestros clientes."
                ];
                return thanks[Math.floor(Math.random() * thanks.length)];
            }
            
            if (message.includes('legal') || message.includes('abogado') || message.includes('derecho')) {
                return "Entiendo que tienes una consulta legal. Nuestro equipo de abogados especializados puede brindarte la asesoría que necesitas. ¿Me podrías dar más detalles sobre tu caso?";
            }
            
            if (message.includes('precio') || message.includes('costo') || message.includes('honorarios')) {
                return "Te entiendo perfectamente. Los honorarios varían según la complejidad del caso. Te proporciono una consulta inicial sin costo para evaluar tu situación. ¿Te parece bien que programemos una cita?";
            }
            
            // Respuestas generales
            const generalResponses = [
                "Comprendo tu situación. Déjame analizar tu consulta para brindarte la mejor asesoría posible.",
                "Entiendo perfectamente lo que me comentas. Mi objetivo es ayudarte a resolver esto de la manera más eficiente.",
                "Te escucho con atención. Cada caso es único y merece una atención personalizada.",
                "Muchas gracias por confiar en nosotros. Estoy aquí para brindarte toda la información y apoyo que necesites."
            ];
            
            return generalResponses[Math.floor(Math.random() * generalResponses.length)];
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Cargar voces cuando el usuario interactúa por primera vez
        document.addEventListener('click', function() {
            if (!isVoicesLoaded) {
                loadOptimalVoice();
            }
        }, { once: true });
    </script>
</body>
</html>
