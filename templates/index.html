<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia - Asistente Virtual</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            background: white;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            color: #2c3e50;
            padding: 15px 20px 10px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo {
            height: 35px;
            width: auto;
            max-width: 85%;
        }
        
        .avatar-container {
            margin: 0 auto 10px;
            width: 80px;
            height: 80px;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #e0e0e0;
            background: #e0e0e0 url('https://bidamericas.com/tusabogados/foto.png') center/cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            display: inline-block;
            background: #f1f2f6;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 8px;
            color: #7f8c8d;
        }
        
        .chat-container {
            background: #f8f9fa;
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #3498db;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .sofia-message {
            background: white;
            color: #2c3e50;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 14px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e0e0e0;
            width: fit-content;
            margin-bottom: 12px;
            font-style: italic;
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: #3498db;
        }
        
        .send-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            background: #2980b9;
        }
        
        /* Nuevo botón "Hablar con Sofia" */
        .talk-button {
            display: block;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            margin: 10px auto 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .talk-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: #2980b9;
        }
        
        .talk-button.listening {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Estilos mejorados para el área de entrada */
        .enhanced-input-container {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .enhanced-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .enhanced-input:focus {
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .enhanced-send-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            margin-left: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .enhanced-send-btn:hover {
            transform: scale(1.05);
            background: #2980b9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .enhanced-send-btn:active {
            transform: scale(0.95);
        }
        
        /* Responsive para móviles */
        @media (max-width: 480px) {
            .header {
                padding: 15px 15px 10px;
            }
            
            .avatar-container {
                width: 70px;
                height: 70px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 13px;
            }
            
            .message {
                font-size: 13px;
                padding: 8px 12px;
            }
            
            .enhanced-input {
                padding: 12px 14px;
                font-size: 15px;
            }
            
            .enhanced-send-btn {
                width: 44px;
                height: 44px;
            }
            
            .talk-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://bidamericas.com/tusabogados/logo.png" alt="Fundación VANALI" class="logo">
            </div>
            
            <div class="header-content">
                <div class="avatar-container">
                    <div class="avatar"></div>
                </div>
                <div class="header-text">
                    <h1>Rocio</h1>
                    <p class="subtitle">Asistente Virtual - Fundación VANALI</p>
                    <button class="talk-button" id="talkButton" onclick="startVoiceRecognition()">
                        Hablar con Rocio
                    </button>
                    <div class="status-indicator" id="statusIndicator">🔴 Inicializando...</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatBox">
            <div class="message sofia-message">
                ¡Hola! Soy Rocio, tu asistente virtual de la Fundación VANALI. Estoy aquí para ayudarte con información sobre nuestros cursos de manualidades. ¿En qué puedo ayudarte hoy?
            </div>
            <div class="typing-indicator" id="typingIndicator">
                Rocio está escribiendo...
            </div>
        </div>

        <div class="enhanced-input-container">
            <input type="text" class="enhanced-input" id="userInput" placeholder="Escribe tu mensaje aquí..." onkeypress="handleKeyPress(event)">
            <button class="enhanced-send-btn" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        let voiceSupported = false;
        let recognition = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            checkVoiceSupport();
            updateStatus('🔍 Inicializando sistema de voz...');
            
            // Mensaje de bienvenida
            setTimeout(() => {
                const welcomeText = "¡Hola! Soy Rocio, tu asistente virtual de la Fundación VANALI. Estoy aquí para ayudarte con información sobre nuestros cursos de manualidades. ¿En qué puedo ayudarte hoy?";
                // Enviar al backend para generar voz
                generateAndPlayAudio(welcomeText);
            }, 1500);
        }

        function checkVoiceSupport() {
            voiceSupported = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            
            if (voiceSupported) {
                updateStatus('🟢 Reconocimiento de voz activo');
            } else {
                updateStatus('🔴 Reconocimiento de voz no compatible');
                document.getElementById('talkButton').style.display = 'none';
            }
        }
        
        function updateStatus(message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            
            if (message.includes('🟢')) {
                indicator.style.background = 'rgba(46, 204, 113, 0.2)';
                indicator.style.color = '#27ae60';
            } else if (message.includes('🔴')) {
                indicator.style.background = 'rgba(231, 76, 60, 0.2)';
                indicator.style.color = '#c0392b';
            } else {
                indicator.style.background = 'rgba(255, 193, 7, 0.2)';
                indicator.style.color = '#d35400';
            }
        }

       function generateAndPlayAudio(text) {
    updateStatus('🔊 Generando audio...');
    
    fetch('/api/speak', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: text })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            console.error('Error from server:', data.error);
            updateStatus('❌ Error: ' + (data.error.message || data.error));
            
            // Mostrar mensaje de error en el chat
            addMessage("Lo siento, hubo un error generando la voz. Por favor, intenta nuevamente.", false);
            return;
        }
        
        if (data.audioContent || data.audioUrl) {
            const audioUrl = data.audioUrl || `data:audio/mp3;base64,${data.audioContent}`;
            const audio = new Audio(audioUrl);
            
            audio.onplay = function() {
                updateStatus('🎵 Reproduciendo voz...');
            };
            
            audio.onended = function() {
                updateStatus('🟢 Voz lista');
            };
            
            audio.onerror = function(e) {
                console.error('Error playing audio:', e);
                updateStatus('❌ Error reproduciendo audio');
            };
            
            // Intentar reproducir
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log('Audio play blocked, requiring user interaction');
                    updateStatus('🔇 Toca para escuchar');
                    
                    // Crear botón para reproducir manualmente
                    const playButton = document.createElement('button');
                    playButton.textContent = '▶️ Escuchar respuesta';
                    playButton.className = 'play-button';
                    playButton.onclick = function() {
                        audio.play();
                        this.remove();
                    };
                    
                    // Añadir botón después del último mensaje
                    const lastMessage = document.querySelector('#chatBox .message:last-child');
                    if (lastMessage) {
                        lastMessage.appendChild(playButton);
                    }
                });
            }
        } else {
            console.error('No audio content received:', data);
            updateStatus('❌ Error generando audio');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        updateStatus('❌ Error de conexión');
        
        // Mostrar mensaje de error en el chat
        addMessage("Error de conexión con el servicio de voz. Por favor, intenta nuevamente.", false);
    });
}

        function startVoiceRecognition() {
            if (!voiceSupported) {
                alert('El reconocimiento de voz no es compatible con tu navegador. Usa Chrome o Edge.');
                return;
            }

            const talkButton = document.getElementById('talkButton');
            
            if (recognition && recognition.isListening) {
                recognition.stop();
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                talkButton.classList.add('listening');
                recognition.isListening = true;
                updateStatus('🎤 Escuchando...');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                sendMessage();
                
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                updateStatus('🟢 Voz lista');
            };
            
            recognition.onerror = function(event) {
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    alert('Error en reconocimiento: ' + event.error);
                    updateStatus('❌ Error de reconocimiento');
                } else {
                    updateStatus('🟢 Voz lista');
                }
            };
            
            recognition.onend = function() {
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                updateStatus('🟢 Voz lista');
            };
            
            try {
                recognition.start();
                updateStatus('🎤 Iniciando reconocimiento...');
            } catch (error) {
                alert('Error al activar el micrófono: ' + error.message);
                updateStatus('❌ Error de micrófono');
            }
        }

        function addMessage(message, isUser = false) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message sofia-message';
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                showTypingIndicator();
                
                // Enviar mensaje al backend para procesamiento
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    hideTypingIndicator();
                    if (data.response) {
                        addMessage(data.response, false);
                        // Generar y reproducir audio con la respuesta
                        generateAndPlayAudio(data.response);
                    } else {
                        addMessage("Lo siento, hubo un error procesando tu mensaje.", false);
                    }
                })
                .catch(error => {
                    hideTypingIndicator();
                    console.error('Error:', error);
                    // Respuesta de respaldo si hay error en la conexión
                    const backupResponses = [
                        "Entiendo tu consulta sobre nuestros cursos. Déjame verificar esa información para ti.",
                        "Gracias por tu mensaje. Estoy buscando la mejor información sobre nuestros cursos para ayudarte.",
                        "Comprendo tu pregunta sobre la Fundación VANALI. Permíteme ayudarte con eso.",
                        "Excelente pregunta sobre nuestros cursos. Déjame consultar los detalles para darte una respuesta precisa."
                    ];
                    const randomResponse = backupResponses[Math.floor(Math.random() * backupResponses.length)];
                    addMessage(randomResponse, false);
                });
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }
    </script>
</body>
</html>
