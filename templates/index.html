<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sofia - Asistente Virtual</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }
        
        .container { 
            background: white; 
            border-radius: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            width: 100%;
            height: 100vh;
            max-width: 100%;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .header { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white;
            padding: 15px 15px 12px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .logo-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .logo {
            height: 30px;
            width: auto;
            max-width: 80%;
        }
        
        .header-content {
            margin-top: 45px;
        }
        
        .avatar-container {
            position: relative; 
            margin: 0 auto 8px; 
            width: 80px; 
            height: 80px;
        }
        
        .avatar { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            border: 3px solid rgba(255,255,255,0.5);
            background: #e0e0e0 center/cover;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        h1 { 
            font-size: 20px; 
            margin-bottom: 3px; 
            font-weight: 600;
        }
        
        .subtitle { 
            font-size: 13px; 
            opacity: 0.9; 
            margin-bottom: 8px; 
        }
        
        .talk-with {
            font-weight: bold;
            margin-top: 5px;
            font-size: 14px;
        }
        
        /* Tabs Navigation */
        .tabs { 
            display: flex; 
            background: rgba(255,255,255,0.15); 
            border-radius: 18px; 
            padding: 3px; 
            margin: 10px auto 0; 
            width: 90%;
        }
        
        .tab { 
            flex: 1; 
            text-align: center; 
            padding: 6px 4px; 
            border-radius: 18px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-size: 12px; 
            font-weight: bold;
        }
        
        .tab.active { 
            background: white; 
            color: #3498db; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Tab Content */
        .tab-content { 
            display: none; 
            flex-grow: 1;
            overflow: hidden;
            height: 100%;
            flex-direction: column;
        }
        
        .tab-content.active { 
            display: flex; 
        }
        
        /* Voice Tab */
        .voice-tab-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            text-align: center;
            height: 100%;
        }
        
        .voice-title {
            font-size: 16px; 
            margin-bottom: 15px; 
            color: #3498db;
            font-weight: 600;
        }
        
        .talk-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 14px 25px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .talk-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        
        .talk-button:active {
            transform: translateY(1px);
        }
        
        .voice-instructions {
            margin-top: 15px; 
            color: #777; 
            font-size: 13px;
            line-height: 1.4;
            max-width: 280px;
        }
        
        /* Chat Tab - CORREGIDO */
        .chat-tab-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
        }
        
        .chat-container { 
            flex: 1;
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 12px;
            display: flex;
            flex-direction: column;
        }
        
        .message { 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-radius: 15px; 
            max-width: 85%; 
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .user-message { 
            background: #3498db; 
            color: white; 
            margin-left: auto; 
            border-bottom-right-radius: 5px;
        }
        
        .sofia-message { 
            background: white; 
            color: #2c3e50; 
            border: 1px solid #e0e0e0; 
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Input Container - CORREGIDO (ahora visible en móviles) */
        .input-container { 
            padding: 12px; 
            background: white; 
            border-top: 1px solid #e0e0e0; 
            display: flex; 
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            width: 100%;
        }
        
        input { 
            flex: 1; 
            padding: 10px 12px; 
            border: 2px solid #e0e0e0; 
            border-radius: 20px; 
            outline: none;
            font-size: 14px; 
            transition: border-color 0.3s;
            height: 40px;
        }
        
        input:focus { 
            border-color: #3498db; 
        }
        
        .send-btn { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer; 
            font-weight: bold; 
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .send-btn:hover { 
            transform: scale(1.05); 
        }
        
        /* History Tab */
        .history-container { 
            height: 100%;
            overflow-y: auto; 
            padding: 12px;
        }
        
        .history-item { 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            align-items: center;
        }
        
        .history-item:last-child { 
            border-bottom: none; 
        }
        
        .history-icon { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            background: #f0f0f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .history-content { 
            flex: 1; 
        }
        
        .history-title { 
            font-weight: bold; 
            margin-bottom: 2px; 
            font-size: 13px;
        }
        
        .history-desc {
            font-size: 12px;
            color: #555;
            margin-bottom: 2px;
        }
        
        .history-time { 
            font-size: 10px; 
            color: #888; 
        }
        
        /* Indicators */
        .typing-indicator { 
            display: none; 
            padding: 8px 12px; 
            background: white; 
            border-radius: 15px; 
            border: 1px solid #e0e0e0;
            width: fit-content; 
            margin-bottom: 10px; 
            font-style: italic; 
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .status-indicator { 
            position: absolute; 
            top: 50px;
            right: 8px; 
            font-size: 9px; 
            background: rgba(255,255,255,0.3);
            padding: 3px 6px; 
            border-radius: 8px;
        }
        
        /* Media Queries mejoradas para móviles */
        @media (max-height: 700px) {
            .header {
                padding: 12px 15px 10px;
            }
            
            .logo {
                height: 25px;
            }
            
            .logo-container {
                padding: 8px 0;
            }
            
            .header-content {
                margin-top: 38px;
            }
            
            .avatar-container {
                width: 70px;
                height: 70px;
                margin-bottom: 6px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .talk-with {
                font-size: 13px;
            }
            
            .tab {
                padding: 5px 3px;
                font-size: 11px;
            }
            
            .chat-container {
                padding: 10px;
            }
            
            .message {
                padding: 7px 10px;
                font-size: 13px;
            }
            
            .talk-button {
                padding: 12px 20px;
                font-size: 14px;
                margin: 15px 0;
            }
            
            .status-indicator {
                top: 42px;
            }
            
            .input-container {
                padding: 10px;
            }
            
            input {
                height: 38px;
                font-size: 13px;
            }
            
            .send-btn {
                width: 38px;
                height: 38px;
            }
        }
        
        /* Landscape orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .header {
                padding: 8px 15px 6px;
            }
            
            .logo-container {
                padding: 6px 0;
            }
            
            .logo {
                height: 22px;
            }
            
            .header-content {
                margin-top: 32px;
            }
            
            .avatar-container {
                width: 50px;
                height: 50px;
                margin-bottom: 4px;
                display: inline-block;
                vertical-align: middle;
                margin-right: 8px;
            }
            
            .header-text {
                display: inline-block;
                vertical-align: middle;
                text-align: left;
            }
            
            h1 {
                font-size: 16px;
                margin-bottom: 0;
            }
            
            .subtitle {
                font-size: 10px;
                margin-bottom: 0;
            }
            
            .talk-with {
                display: none;
            }
            
            .tabs {
                width: auto;
                display: inline-block;
                margin-left: 8px;
            }
            
            .voice-tab-content {
                padding: 8px;
            }
            
            .talk-button {
                padding: 8px 15px;
                font-size: 12px;
                margin: 12px 0;
            }
            
            .status-indicator {
                top: 32px;
                right: 6px;
            }
            
            .chat-container {
                padding: 8px;
            }
            
            .input-container {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="/templates/logo.png" alt="Fusa Abogados" class="logo" onerror="this.style.display='none'">
            </div>
            <div class="status-indicator">🔴 Sin voz</div>
            
            <div class="header-content">
                <div class="avatar-container">
                    <div class="avatar" style="background-image: url('/templates/foto.png')"></div>
                </div>
                <div class="header-text">
                    <h1>Sofia 💡</h1>
                    <p class="subtitle">Representante de atención al cliente</p>
                    <div class="talk-with">- Hablar con Sofia</div>
                </div>
                
                <!-- Tabs Navigation -->
                <div class="tabs">
                    <div class="tab" data-tab="chat">Chat</div>
                    <div class="tab active" data-tab="voice">Voz</div>
                    <div class="tab" data-tab="history">Historial</div>
                </div>
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div class="tab-content" id="chatTab">
            <div class="chat-tab-content">
                <div class="chat-container" id="chatBox">
                    <div class="message sofia-message">
                        ¡Hola! Soy Sofia, tu representante de atención al cliente. ¿En qué puedo ayudarte hoy?
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        Sofia está escribiendo...
                    </div>
                </div>

                <div class="input-container">
                    <input type="text" id="userInput" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">→</button>
                </div>
            </div>
        </div>

        <!-- Voice Tab Content - ABIERTA POR DEFECTO -->
        <div class="tab-content active" id="voiceTab">
            <div class="voice-tab-content">
                <div class="voice-title">
                    Habla con Sofia usando tu voz
                </div>
                
                <button class="talk-button" onclick="startVoiceRecognition()">
                    🎤 Hablar con Sofia
                </button>
                
                <div class="voice-instructions">
                    <p>Haz clic en el botón y permite el acceso al micrófono cuando te lo solicite el navegador.</p>
                </div>
            </div>
        </div>

        <!-- History Tab Content -->
        <div class="tab-content" id="historyTab">
            <div class="history-container">
                <div class="history-item">
                    <div class="history-icon">📞</div>
                    <div class="history-content">
                        <div class="history-title">Llamada de servicio</div>
                        <div class="history-desc">Consulta sobre garantía de producto</div>
                        <div class="history-time">Hace 2 horas</div>
                    </div>
                </div>
                <div class="history-item">
                    <div class="history-icon">💬</div>
                    <div class="history-content">
                        <div class="history-title">Chat en línea</div>
                        <div class="history-desc">Solicitud de información de envío</div>
                        <div class="history-time">Ayer</div>
                    </div>
                </div>
                <div class="history-item">
                    <div class="history-icon">📧</div>
                    <div class="history-content">
                        <div class="history-title">Correo electrónico</div>
                        <div class="history-desc">Respuesta a consulta técnica</div>
                        <div class="history-time">Hace 3 días</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let voiceSupported = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            checkVoiceSupport();
            setupTabs();
            preloadImages();
            
            // Ajustar altura del contenedor de chat para dispositivos móviles
            adjustChatHeight();
            window.addEventListener('resize', adjustChatHeight);
        });

        function preloadImages() {
            // Precargar imágenes y manejar errores
            const logo = new Image();
            logo.src = '/templates/logo.png';
            logo.onerror = function() {
                console.log('Logo no encontrado en /templates/logo.png');
            }
            
            const avatar = new Image();
            avatar.src = '/templates/foto.png';
            avatar.onerror = function() {
                console.log('Avatar no encontrado en /templates/foto.png');
                // Usar avatar por defecto si no se encuentra la imagen
                document.querySelector('.avatar').style.backgroundImage = "url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2240%22 r=%2230%22 fill=%22%233498db%22/><rect x=%2225%22 y=%2275%22 width=%2250%22 height=%2230%22 fill=%22%233498db%22/><circle cx=%2235%22 cy=%2230%22 r=%225%22 fill=%22white%22/><circle cx=%2265%22 cy=%2230%22 r=%225%22 fill=%22white%22/></svg>')";
            }
        }

        function adjustChatHeight() {
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) {
                const headerHeight = document.querySelector('.header').offsetHeight;
                const inputHeight = document.querySelector('.input-container').offsetHeight;
                const windowHeight = window.innerHeight;
                
                // Asegurar que el chat sea visible en móviles
                const calculatedHeight = windowHeight - headerHeight - inputHeight;
                chatContainer.style.height = Math.max(calculatedHeight, 100) + 'px';
            }
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                    
                    // Ajustar alturas después de cambiar pestaña
                    setTimeout(adjustChatHeight, 50);
                });
            });
        }

        function checkVoiceSupport() {
            voiceSupported = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) && 
                            'speechSynthesis' in window;
            
            if (voiceSupported) {
                document.querySelector('.status-indicator').textContent = '🟢 Voz activa';
                document.querySelector('.status-indicator').style.background = 'rgba(46, 204, 113, 0.3)';
            }
        }

        function startVoiceRecognition() {
            if (!voiceSupported) {
                alert('El reconocimiento de voz no es compatible con tu navegador. Usa Chrome o Edge.');
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            
            recognition.onstart = function() {
                document.getElementById('userInput').placeholder = "Escuchando...";
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                document.getElementById('userInput').placeholder = "Escribe tu mensaje...";
                sendMessage();
            };
            
            recognition.onerror = function(event) {
                document.getElementById('userInput').placeholder = "Escribe tu mensaje...";
                alert('Error en reconocimiento: ' + event.error);
            };
            
            recognition.start();
        }

        function speakText(text) {
            if (!voiceSupported) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            
            speechSynthesis.speak(utterance);
        }

        function addMessage(message, isUser = false) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message sofia-message';
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage('Tú: ' + message, true);
                input.value = '';
                
                showTypingIndicator();
                
                // Cambiar a la pestaña de chat si no está activa
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="chat"]').classList.add('active');
                document.getElementById('chatTab').classList.add('active');
                
                // Ajustar altura después de cambiar pestaña
                setTimeout(adjustChatHeight, 100);
                
                // Simular respuesta del servidor
                setTimeout(() => {
                    hideTypingIndicator();
                    const responses = [
                        "Entiendo tu consulta. Déjame verificar esa información para ti.",
                        "Gracias por tu mensaje. Estoy buscando la mejor solución para tu caso.",
                        "Comprendo tu situación. Permíteme ayudarte con eso.",
                        "Excelente pregunta. Déjame consultar los detalles para darte una respuesta precisa."
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addMessage('Sofia: ' + randomResponse, false);
                    speakText(randomResponse);
                }, 1500);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>
