<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocio - Asistente Virtual</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            background: white;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .header {
            background: white;
            color: #2c3e50;
            padding: 15px 20px 10px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logo {
            height: 35px;
            width: auto;
            max-width: 85%;
        }
        
        .avatar-container {
            margin: 0 auto 10px;
            width: 80px;
            height: 80px;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #e0e0e0;
            background: #e0e0e0 url('https://bidamericas.com/vanali/foto.png') center/cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            display: inline-block;
            background: #f1f2f6;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 8px;
            color: #7f8c8d;
        }
        
        .chat-container {
            background: #f8f9fa;
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #6b0366;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .sofia-message {
            background: white;
            color: #2c3e50;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Estilos para el contenedor de video */
        .video-message {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px;
            max-width: 85%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-container iframe {
            width: 100%;
            height: 200px;
            border: none;
            border-radius: 8px;
        }
        
        .video-caption {
            padding: 8px 5px 0;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 14px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e0e0e0;
            width: fit-content;
            margin-bottom: 12px;
            font-style: italic;
            color: #7f8c8d;
            font-size: 13px;
        }
        
        /* Estilos mejorados para el área de entrada */
        .enhanced-input-container {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }
        
        .enhanced-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .enhanced-input:focus {
            border-color: #6b0366;
            background: white;
            box-shadow: 0 0 0 3px rgba(107, 3, 102, 0.2);
        }
        
        .enhanced-send-btn {
            background: #6b0366;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            margin-left: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .enhanced-send-btn:hover {
            transform: scale(1.05);
            background: #5a0255;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .enhanced-send-btn:active {
            transform: scale(0.95);
        }
        
        /* Nuevo botón "Hablar con Rocio" */
        .talk-button {
            display: block;
            background: #6b0366;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            margin: 10px auto 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .talk-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: #5a0255;
        }
        
        .talk-button.listening {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Botón de WhatsApp flotante - POSICIÓN AJUSTADA */
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 85px; /* Cambiado de 25px a 85px para que no tape el botón de enviar */
            right: 25px;
            background-color: #FFF;
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.5);
            z-index: 1000;
            animation: whatsappBounce 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .whatsapp-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(37, 211, 102, 0.6);
        }
        
        .whatsapp-icon {
            width: 35px;
            height: 35px;
        }
        
        @keyframes whatsappBounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        /* Tooltip para WhatsApp */
        .whatsapp-tooltip {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .whatsapp-float:hover .whatsapp-tooltip {
            opacity: 1;
        }
        
        /* Responsive para móviles */
        @media (max-width: 480px) {
            .header {
                padding: 15px 15px 10px;
            }
            
            .avatar-container {
                width: 70px;
                height: 70px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 13px;
            }
            
            .message {
                font-size: 13px;
                padding: 8px 12px;
            }
            
            .video-message {
                max-width: 90%;
            }
            
            .video-container iframe {
                height: 180px;
            }
            
            .enhanced-input {
                padding: 12px 14px;
                font-size: 15px;
            }
            
            .enhanced-send-btn {
                width: 44px;
                height: 44px;
            }
            
            .talk-button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .whatsapp-float {
                width: 55px;
                height: 55px;
                bottom: 80px; /* Ajustado para móviles también */
                right: 20px;
            }
            
            .whatsapp-icon {
                width: 30px;
                height: 30px;
            }
            
            /* Ajustes específicos para cuando el teclado está visible */
            .keyboard-visible .header {
                display: none;
            }
            
            .keyboard-visible .chat-container {
                padding-bottom: 5px;
            }
            
            .keyboard-visible .whatsapp-float {
                display: none;
            }
        }

        @media (min-width: 768px) {
            .video-container iframe {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Botón flotante de WhatsApp con icono whats.png -->
    <a class="whatsapp-float" id="whatsappButton" href="https://api.whatsapp.com/send?phone=573208744749&text=Hola,%20deseo%20más%20información%20de%20los%20cursos." target="_blank">
        <img src="https://bidamericas.com/vanali/whats.png" alt="WhatsApp" class="whatsapp-icon">
        <div class="whatsapp-tooltip">¡Contáctanos por WhatsApp!</div>
    </a>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://bidamericas.com/vanali/logo.png" alt="Fundación VANALI" class="logo">
            </div>
            
            <div class="header-content">
                <div class="avatar-container">
                    <div class="avatar"></div>
                </div>
                <div class="header-text">
                    <h1>Rocio</h1>
                    <p class="subtitle">Asistente Virtual - Fundación VANALI</p>
                    <button class="talk-button" id="talkButton" onclick="startVoiceRecognition()">
                        Hablar con Rocio
                    </button>
                    <div class="status-indicator" id="statusIndicator">🔴 Inicializando...</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatBox">
            <div class="message sofia-message">
                ¡Hola! Soy Rocio, tu asistente virtual de la Fundación VANALI. Estoy aquí para ayudarte con información sobre nuestros cursos de manualidades. ¿En qué puedo ayudarte hoy?
            </div>
            
            <!-- Videos de Papá Noel y Mamá Noel -->
            <div class="video-message">
                <div class="video-container">
                    <iframe src="https://www.youtube.com/embed/xat_hEOVnIU" title="Papá Noel - Fundación VANALI" allowfullscreen></iframe>
                </div>
                <div class="video-caption">Papá Noel - Fundación VANALI</div>
            </div>
            
            <div class="video-message">
                <div class="video-container">
                    <iframe src="https://www.youtube.com/embed/rkl27vNtfKI" title="Mamá Noel - Fundación VANALI" allowfullscreen></iframe>
                </div>
                <div class="video-caption">Mamá Noel - Fundación VANALI</div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Rocio está escribiendo...
            </div>
        </div>

        <div class="enhanced-input-container" id="inputContainer">
            <input type="text" class="enhanced-input" id="userInput" placeholder="Escribe tu mensaje aquí..." onkeypress="handleKeyPress(event)">
            <button class="enhanced-send-btn" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        let voiceSupported = false;
        let recognition = null;
        let isKeyboardVisible = false;
        let welcomeVideoShown = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupViewportHandlers();
        });

        function initializeApp() {
            checkVoiceSupport();
            updateStatus('🔍 Inicializando sistema de voz...');
            
            // Mensaje de bienvenida
            setTimeout(() => {
                const welcomeText = "¡Hola! Soy Rocio, tu asistente virtual de la Fundación VANALI. Estoy aquí para ayudarte con información sobre nuestros cursos de manualidades. ¿En qué puedo ayudarte hoy?";
                // Enviar al backend para generar voz
                generateAndPlayAudio(welcomeText);
            }, 1500);
        }

        function setupViewportHandlers() {
            const visualViewport = window.visualViewport;
            
            if (visualViewport) {
                visualViewport.addEventListener('resize', function() {
                    const keyboardThreshold = window.innerHeight * 0.4;
                    isKeyboardVisible = visualViewport.height < window.innerHeight - keyboardThreshold;
                    
                    if (isKeyboardVisible) {
                        document.body.classList.add('keyboard-visible');
                        scrollToLatestMessage();
                    } else {
                        document.body.classList.remove('keyboard-visible');
                    }
                });
            }
            
            document.getElementById('chatBox').addEventListener('touchstart', function() {
                document.getElementById('userInput').focus();
            });
        }

        function scrollToLatestMessage() {
            const chatBox = document.getElementById('chatBox');
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        }

        function checkVoiceSupport() {
            voiceSupported = ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);
            
            if (voiceSupported) {
                updateStatus('🟢 Reconocimiento de voz activo');
            } else {
                updateStatus('🔴 Reconocimiento de voz no compatible');
                document.getElementById('talkButton').style.display = 'none';
            }
        }
        
        function updateStatus(message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            
            if (message.includes('🟢')) {
                indicator.style.background = 'rgba(46, 204, 113, 0.2)';
                indicator.style.color = '#27ae60';
            } else if (message.includes('🔴')) {
                indicator.style.background = 'rgba(231, 76, 60, 0.2)';
                indicator.style.color = '#c0392b';
            } else {
                indicator.style.background = 'rgba(255, 193, 7, 0.2)';
                indicator.style.color = '#d35400';
            }
        }

        function generateAndPlayAudio(text) {
            updateStatus('🔊 Generando audio...');
            
            fetch('/api/speak', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error from server:', data.error);
                    updateStatus('❌ Error: ' + (data.error.message || data.error));
                    addMessage("Lo siento, hubo un error generando la voz. Por favor, intenta nuevamente.", false);
                    return;
                }
                
                if (data.audioContent || data.audioUrl) {
                    const audioUrl = data.audioUrl || `data:audio/mp3;base64,${data.audioContent}`;
                    const audio = new Audio(audioUrl);
                    
                    audio.onplay = function() {
                        updateStatus('🎵 Reproduciendo voz...');
                    };
                    
                    audio.onended = function() {
                        updateStatus('🟢 Voz lista');
                    };
                    
                    audio.onerror = function(e) {
                        console.error('Error playing audio:', e);
                        updateStatus('❌ Error reproduciendo audio');
                    };
                    
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('Audio play blocked, requiring user interaction');
                            updateStatus('🔇 Toca para escuchar');
                            
                            const playButton = document.createElement('button');
                            playButton.textContent = '▶️ Escuchar respuesta';
                            playButton.className = 'play-button';
                            playButton.onclick = function() {
                                audio.play();
                                this.remove();
                            };
                            
                            const lastMessage = document.querySelector('#chatBox .message:last-child');
                            if (lastMessage) {
                                lastMessage.appendChild(playButton);
                            }
                        });
                    }
                } else {
                    console.error('No audio content received:', data);
                    updateStatus('❌ Error generando audio');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                updateStatus('❌ Error de conexión');
                addMessage("Error de conexión con el servicio de voz. Por favor, intenta nuevamente.", false);
            });
        }

        function startVoiceRecognition() {
            if (!voiceSupported) {
                alert('El reconocimiento de voz no es compatible con tu navegador. Usa Chrome o Edge.');
                return;
            }

            const talkButton = document.getElementById('talkButton');
            
            if (recognition && recognition.isListening) {
                recognition.stop();
                return;
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = function() {
                talkButton.classList.add('listening');
                recognition.isListening = true;
                updateStatus('🎤 Escuchando...');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                sendMessage();
                
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                updateStatus('🟢 Voz lista');
            };
            
            recognition.onerror = function(event) {
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    alert('Error en reconocimiento: ' + event.error);
                    updateStatus('❌ Error de reconocimiento');
                } else {
                    updateStatus('🟢 Voz lista');
                }
            };
            
            recognition.onend = function() {
                talkButton.classList.remove('listening');
                recognition.isListening = false;
                updateStatus('🟢 Voz lista');
            };
            
            try {
                recognition.start();
                updateStatus('🎤 Iniciando reconocimiento...');
            } catch (error) {
                alert('Error al activar el micrófono: ' + error.message);
                updateStatus('❌ Error de micrófono');
            }
        }

        function addMessage(message, isUser = false) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message sofia-message';
            messageDiv.textContent = message;
            chatBox.appendChild(messageDiv);
            
            scrollToLatestMessage();
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            scrollToLatestMessage();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                showTypingIndicator();
                
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    hideTypingIndicator();
                    if (data.response) {
                        addMessage(data.response, false);
                        generateAndPlayAudio(data.response);
                    } else {
                        addMessage("Lo siento, hubo un error procesando tu mensaje.", false);
                    }
                })
                .catch(error => {
                    hideTypingIndicator();
                    console.error('Error:', error);
                    const backupResponses = [
                        "Entiendo tu consulta sobre nuestros cursos. Déjame verificar esa información para ti.",
                        "Gracias por tu mensaje. Estoy buscando la mejor información sobre nuestros cursos para ayudarte.",
                        "Comprendo tu pregunta sobre la Fundación VANALI. Permíteme ayudarte con eso.",
                        "Excelente pregunta sobre nuestros cursos. Déjame consultar los detalles para darte una respuesta precisa."
                    ];
                    const randomResponse = backupResponses[Math.floor(Math.random() * backupResponses.length)];
                    addMessage(randomResponse, false);
                });
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }
    </script>
</body>
</html>
